name: Feature Pipeline

on:
  schedule:
    # Run hourly for fresh data
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Pipeline mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - backfill
      years:
        description: 'Years of historical data'
        required: false
        default: '2'
        type: string

jobs:
  feature-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -q -r requirements.txt
      
      - name: Run Feature Pipeline
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: ${{ secrets.HOPSWORKS_PROJECT }}
          OPENWEATHERMAP_API_KEY: ${{ secrets.OPENWEATHERMAP_API_KEY }}
          AQICN_API_TOKEN: ${{ secrets.AQICN_API_TOKEN }}
          WEATHERAPI_KEY: ${{ secrets.WEATHERAPI_KEY }}
        run: |
          if [ "${{ github.event.inputs.mode }}" == "backfill" ]; then
            python -m features.main --mode backfill --years ${{ github.event.inputs.years || 2 }}
          else
            python -m features.main --mode incremental --hours 24
          fi
      
      - name: Upload features to Hopsworks
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: ${{ secrets.HOPSWORKS_PROJECT }}
        run: |
          python scripts/upload_features_to_hopsworks.py
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: features
          path: data/processed/
          retention-days: 7
